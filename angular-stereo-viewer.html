<!DOCTYPE html><html ng-app="html5StereoViewerApp"><head><title>HTML5 Stereo viewer</title><script src="bower_components/angular/angular.js"></script><style>    html, body {        width: 100%;        height: 100%;        margin: 0;        padding: 0;    }    #viewer {        box-sizing: border-box;        width: 100%;        height: 100%;        background: gray;        position: relative;        display: table;    }    canvas {        cursor: pointer;        max-height: 100%;        max-width: 100%;        margin: auto;        position: absolute;        top: 0;        bottom: 0;        left: 0;        right: 0;    }    .info {        display: table-cell;        vertical-align: middle;        text-align: center;        width: 200px;        font-family: courier;    }    .images {        background: black;    }</style><script>    'use strict';    angular.module('html5StereoViewerApp', [])    .controller('html5StereoViewer', function ($scope, $window) {        $scope.mode = 'single';        $scope.invert = 'false';        $scope.pan = [0, 0];        $scope.hotkey = function (event) {            switch (event.which) {                case 32: // space                    $scope.mode = ($scope.mode === 'single') ? 'double' : 'single';                    break;                case 73: // i                    $scope.invert = ($scope.invert === 'true') ? 'false' : 'true';                    break;                case 13: // enter                    break;                case 40:                    $scope.pan = [$scope.pan[0], $scope.pan[1] + 1];                    break;                case 37:                    $scope.pan = [$scope.pan[0] - 1, $scope.pan[1]];                    break;                case 39:                    $scope.pan = [$scope.pan[0] + 1, $scope.pan[1]];                    break;                case 38:                    $scope.pan = [$scope.pan[0], $scope.pan[1] - 1];                    break;            }        };    })    .directive('draginimage', function ($q) {        'use strict';        var URL = window.URL || window.webkitURL;        var dragenter = function (event) {            event.preventDefault();            event.dataTransfer.effectAllowed = 'copy';            return false;        };        return {            restrict: 'A',            scope: {                draginimage: '='            },            link: function (scope, element) {                element.bind('dragover', dragenter);                element.bind('dragenter', dragenter);                element.bind('drop', function (event) {                    event.preventDefault();                    var files = event.dataTransfer.files;                    scope.$apply(function () {                        scope.draginimage = [];                        for (var i = 0; i < files.length; i++) {                            scope.draginimage.push({                                file: files[i],                                url: URL.createObjectURL(files[i])                            });                        }                    });                });            }        };    })    .directive('stereoimage', function () {        'use strict';        var cache = {};        function getImage(url, cb) {            if (cache.url) {                cb(cache[url]);            }            var image = new Image();            image.onload = function () {                cache[url] = image;                cb(image);            }            image.src = url;        }        function getImageData(url, cb, dohalf, pan) {            getImage(url, function (img) {                var c = document.createElement('canvas');                var w = img.width, h = img.height;                c.width = w;                c.height = h;                var ctx = c.getContext('2d');                if (pan) {                    ctx.drawImage(img, pan[0], pan[1], w, h);                } else {                    ctx.drawImage(img, 0, 0, w, h);                }                if (dohalf) {                    var half = Math.round(w / 2); // round up/down? todo                    cb(ctx.getImageData(0, 0, half, h), ctx.getImageData(half, 0, half, h));                } else {                    cb(ctx.getImageData(0, 0, w, h));                }            });        }        return {            restrict: 'A',            scope: {                stereoimage: '=',                mode: '=',                pan: '=',                invert: '=',                export: '='            },            link: function (scope, element) {                var ctx = element[0].getContext('2d');                function simpleStereo(leftImage, rightImage) {                    if (scope.invert === 'false') {                        leftImage = [rightImage, rightImage = leftImage][0];                    }                    element[0].width = leftImage.width;                    element[0].height = leftImage.height;                    ctx.width = leftImage.width;                    ctx.height = leftImage.height;                    // ja vem da ni blo treba filtrirat slik, sam rabim imageData                    // sum images                    var leftImagedata = leftImage.data;                    var rightImagedata = rightImage.data;                    for (var p = 0; p < leftImagedata.length; p += 4) {                        leftImagedata[p] = rightImagedata[p];                    }                    ctx.putImageData(leftImage, 0, 0);                }                scope.$watchCollection('[stereoimage, mode, pan, invert]', function (arg) {                    if (arg) {                        if (scope.stereoimage && scope.stereoimage.length > 0) {                            if (scope.stereoimage.length > 1) {                                // stereo                                getImageData(scope.stereoimage[0].url, function (leftImage) {                                    getImageData(scope.stereoimage[1].url, function (rightImage) {                                        simpleStereo(rightImage, leftImage);                                    });                                });                            } else if (scope.mode === 'single') {                                // samo ena slika                                getImageData(scope.stereoimage[0].url, function (leftImage) {                                    getImageData(scope.stereoimage[0].url, function (rightImage) {                                        simpleStereo(rightImage, leftImage);                                    }, false, [-scope.pan[0], -scope.pan[1]]);                                }, false, scope.pan);                            } else {                                // dupla slika                                getImageData(scope.stereoimage[0].url, simpleStereo, true);                            }                        }                    }                }, true);                element.bind('click', function (event) {                    var pom = document.createElement('a');                    pom.setAttribute('href', element[0].toDataURL('image/png'));                    pom.setAttribute('download', 'stereo.png');                    pom.click();                });            }        };    });</script></head><body ng-controller="html5StereoViewer" ng-keydown="hotkey($event)"><div id="viewer" draginimage="images" ng-class="{images: images}">    <canvas ng-if="images" stereoimage="images" mode="mode" pan="pan" export="export" invert="invert"></canvas>    <div class="info" ng-hide="images">        Drop one/two images.<br/>        Press <b>space</b> to toggle dual panel image.<br/>        Use arrow keys to adjust stereo in single image mode.<br/>        Press <b>i</b> to invert sides.<br/>        Click on image to save it.<br/>        <br/>        (c) marko zabreznik    </div></div></body></html>